<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<!-- 鎖縮放，避免 iOS 匯出前自動放大成預覽 -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>儀器合約注意事項</title>

<!-- 主庫；若被擋，程式會自動用 jsDelivr 補載 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --page-w:210mm; --page-h:297mm; --page-pad:12mm;
    --brand-blue:#004d99;
    --ink:#333; --muted:#555; --border:#d0d7de;
    --hl:#6a1b9a; --hl-bg:#f3e5f5; --hl-bg-strong:#ede7f6;
  }
  html, body { height:100%; }
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
    margin:0; background:#f4ffec; color:var(--ink);
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }
  .container{ max-width:960px; margin:16px auto; background:#fff; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.08); border-radius:12px; }
  h1{ text-align:center; color:#004d99; border-bottom:3px solid #004d99; padding:12px 8px 16px; margin:4px 0 24px; font-weight:700; font-size:clamp(18px,2.6vw,28px); }
  .input-group{ margin-bottom:12px; }
  .input-group label{ display:block; margin:0 0 6px; font-weight:600; color:#555; }
  .input-group input, .input-group select{ width:100%; padding:12px; border:1px solid #d0d7de; border-radius:8px; font-size:16px; }
  .input-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .button-group{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px; }
  #generateBtn,#pdfExportBtn{ padding:12px; border:none; border-radius:10px; cursor:pointer; font-size:18px; }
  #generateBtn{ background:#2e7d32; color:#fff; }
  #pdfExportBtn{ background:#3f51b5; color:#fff; display:none; }
  #generateBtn:hover,#pdfExportBtn:hover{ filter:brightness(.95); }
  #output-container{ margin-top:20px; padding:16px; border:2px dashed #d7d7d7; background:#fafafa; border-radius:10px; overflow:auto; }

  /* A4 內容（桌機 A4；手機僅改預覽，匯出會還原） */
  #pdf-content-wrapper{
    width:var(--page-w); min-height:var(--page-h); padding:var(--page-pad);
    box-sizing:border-box; background:#fff; margin:0 auto;
    font-family:"Times New Roman","Noto Serif TC",serif; font-size:12pt; line-height:1.35;
    transform-origin:top left;
  }
  .document-title{ text-align:center; font-size:16pt; font-weight:700; margin:0 0 4px; }
  .document-subtitle{ text-align:center; font-size:13pt; margin:0 0 8px; border-bottom:1px solid #000; padding-bottom:4px; }
  .info-group{ margin:8px 0 10px; }
  .info-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; }
  .kv{ display:grid; grid-template-columns:max-content 1fr; align-items:center; column-gap:8px; min-height:24px; }
  .kv .k{ font-weight:600; color:#000; min-width:88px; }
  .kv .v{ border-bottom:1px dashed #bbb; padding:1px 2px 2px; }
  .highlight{ font-weight:700; color:#6a1b9a; background:#f3e5f5; padding:1px 4px; border-radius:3px; }
  .highlight-amount{ font-weight:700; color:#6a1b9a; background:#ede7f6; padding:1px 4px; border-radius:3px; line-height:1; display:inline-block; vertical-align:middle; }
  .section-title{ font-weight:700; color:#004d99; margin-top:10px; display:block; }
  .section-title.red{ color:#d32f2f; }

  #pdf-content-wrapper p{ margin:4px 0; }
  #pdf-content-wrapper ol{ margin:4px 0 6px 20px; padding-left:2px; }
  #pdf-content-wrapper, #pdf-content-wrapper *{ page-break-inside:auto; }
  @page{ margin:0; }

  /* 手機預覽（匯出會還原為 12pt） */
  @media (max-width:768px){
    .container{ margin:8px; padding:14px; }
    .input-row{ grid-template-columns:1fr; }
    .button-group{ grid-template-columns:1fr; position:sticky; bottom:0; background:#fff; padding-bottom:6px; }
    .info-grid{ grid-template-columns:1fr; }
    #pdf-content-wrapper{ width:100% !important; min-height:auto; padding:16px; font-size:14px; transform:none !important; }
  }

  /* 匯出鎖定：避免 iOS 在匯出時切到預覽 */
  body.exporting{ overflow:hidden; }
  body.exporting #pdf-content-wrapper{
    position:fixed !important; left:0 !important; top:0 !important; margin:0 !important;
    width:210mm !important; min-height:297mm !important; padding:12mm !important;
    transform:none !important; -webkit-transform:none !important;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>儀器合約注意事項</h1>

    <form id="contractForm">
      <div class="input-group">
        <label for="campusSelect">請選擇院區:</label>
        <select id="campusSelect" required>
          <option value="" disabled selected>-- 請選擇院區 --</option>
          <option value="總院">總院</option>
          <option value="佳里">佳里</option>
          <option value="柳營">柳營</option>
        </select>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="orderNumber">請購單編號:</label>
          <input type="text" id="orderNumber" placeholder="請輸入請購單編號" required>
        </div>
        <div class="input-group">
          <label for="productName">儀器/設備 品名:</label>
          <input type="text" id="productName" placeholder="例如：關節鏡" required>
        </div>
      </div>

      <div class="input-group">
        <label for="deliveryDate">約交日:</label>
        <input type="text" id="deliveryDate" placeholder="例如：114/12/19" required>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="processorName">採購經辦姓名:</label>
          <input type="text" id="processorName" placeholder="請輸入經辦姓名" required>
        </div>
        <div class="input-group">
          <label for="processorExt">採購經辦分機:</label>
          <input type="text" id="processorExt" placeholder="請輸入分機號碼" required>
        </div>
      </div>

      <div class="input-group">
        <label for="totalAmount">合約總金額 (僅輸入數字):</label>
        <input type="number" id="totalAmount" placeholder="例如：191000" min="0" step="0.01" required>
      </div>

      <div class="button-group">
        <button type="submit" id="generateBtn">生成合約注意事項</button>
        <button type="button" id="pdfExportBtn">匯出 PDF 檔案</button>
      </div>
    </form>

    <div id="output-container">
      <p style="text-align:center;color:#888;">請輸入上方資訊並點擊按鈕生成文件</p>
    </div>
  </div>

<script>
  // ===== 原始資料 =====
  const CAMPUS_DATA = {
    "總院": { name: "奇美醫療財團法人奇美醫院 (總院)", phone: "06-2812811" },
    "佳里": { name: "奇美醫療財團法人奇美醫院 (佳里院區)", phone: "06-7263333" },
    "柳營": { name: "奇美醫療財團法人奇美醫院 (柳營院區)", phone: "06-6226999" }
  };
  const contractForm = document.getElementById('contractForm');
  const pdfExportBtn = document.getElementById('pdfExportBtn');
  const outputContainer = document.getElementById('output-container');
  let currentOrderNumber = "";

  // 預覽縮放（匯出中不動版面）
  function fitPreviewToScreen(){
    if (window.__exporting) return;
    const el = document.getElementById('pdf-content-wrapper');
    if(!el) return;
    if(window.innerWidth < 768){ el.style.transform='none'; return; }
    const rawW = el.getBoundingClientRect().width;
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const scale = Math.min(1, (vw - 32) / rawW);
    el.style.transformOrigin = 'top left';
    el.style.transform = `scale(${scale})`;
  }
  window.addEventListener('resize', fitPreviewToScreen);

  contractForm.addEventListener('submit', (e)=>{ e.preventDefault(); generateContract(); });
  pdfExportBtn.addEventListener('click', exportToPDF);

  function formatCurrency(n){ return n.toLocaleString('en-US',{minimumFractionDigits:0, maximumFractionDigits:0}); }

  function generateContract(){
    const campusKey     = document.getElementById('campusSelect').value;
    const orderNumber   = document.getElementById('orderNumber').value.trim();
    const productName   = document.getElementById('productName').value.trim();
    const deliveryDate  = document.getElementById('deliveryDate').value.trim();
    const totalAmount   = parseFloat(document.getElementById('totalAmount').value);
    const processorName = document.getElementById('processorName').value.trim();
    const processorExt  = document.getElementById('processorExt').value.trim();

    if(!campusKey){ outputContainer.innerHTML = '<p style="color:#b00020;text-align:center;">請先選擇院區。</p>'; pdfExportBtn.style.display='none'; return; }
    if(isNaN(totalAmount) || totalAmount<=0){ outputContainer.innerHTML = '<p style="color:#b00020;text-align:center;">請輸入有效的合約總金額。</p>'; pdfExportBtn.style.display='none'; return; }

    const campusInfo = CAMPUS_DATA[campusKey];
    currentOrderNumber = orderNumber;

    const p20 = formatCurrency(totalAmount * 0.20);
    const p30 = formatCurrency(totalAmount * 0.30);

    const html = `
<div id="pdf-content-wrapper">
  <div class="document-title">${campusInfo.name}</div>
  <div class="document-subtitle">【儀器合約注意事項】</div>

  <div class="info-group">
    <div class="info-grid">
      <div class="kv"><div class="k">請購單編號：</div><div class="v"><span class="highlight">${orderNumber}</span></div></div>
      <div class="kv"><div class="k">醫院電話：</div><div class="v"><span class="highlight">${campusInfo.phone}</span>　分機：<span class="highlight">${processorExt}</span></div></div>
      <div class="kv"><div class="k">品名：</div><div class="v"><span class="highlight">${productName}</span></div></div>
      <div class="kv"><div class="k">經辦人：</div><div class="v"><span class="highlight">${processorName}</span></div></div>
    </div>
  </div>

  <p>空白合約為 <b>一式兩份正本、一本副本</b>（副本僅需作前四頁即可）。</p>

  <ol>
    <li>合約內容之 <b>品名、規格、數量（大寫）</b> 皆須填寫完整。</li>
    <li><b>交貨期限</b> 需與請購單之 <b>約交日</b> 一致。約交日：<span class="highlight">${deliveryDate}</span></li>
    <li>總價、保固年限需固定 <b>大寫</b>（壹、貳、參、肆、伍……）。</li>
    <li>
      合約製作同時需付總價 <b>20%</b> 之 <b>履約保固金</b>
      （公司支票 <span class="highlight-amount">$ ${p20}</span>）
      <div class="cont"><b>若無保證人</b> 其需支付總額 <b>30%</b> 履約保固金
      （公司支票 <span class="highlight-amount">$ ${p30}</span>）</div>
      <div class="cont">支票影本需浮貼於支票影本黏貼處，並檢附支票正本。</div>
    </li>
    <li>兩份正本皆需貼印花（各貼 12 元，共 24 元）。</li>
    <li>乙方、保證人皆需蓋公司大小章。</li>
    <li>若儀器無額外零配件，需於零配件表填寫 <b>「以下空白」</b>。</li>
    <li>廠商保密切結書需蓋公司大小章。</li>
    <li>合約內容需附報價單（原報價日期及議價金額）、型錄（影本可）、授權書及衛署許可證。</li>
    <li>合約請裝訂完後再蓋騎縫章，若有修改請蓋小章。</li>
    <li>外部人員保密切結書需業務本人親筆簽名或蓋章，勿僅是電子簽名。</li>
  </ol>

  <p class="section-title red">交機注意：</p>
  <p style="margin-left:12px;">需提前一天通知以下三單位，以便點交及作帳。</p>
  <ol>
    <li>補給組</li>
    <li>醫工組</li>
    <li>使用單位</li>
  </ol>

  <p style="font-weight:bold; margin-top:8px;">※ 於交機時，一併檢附該筆請購單之發票；如為電子發票，需將電子發票證明聯印出。</p>
  <p style="font-weight:bold;">請於交貨前完成合約簽訂，謝謝。</p>
</div>`;
    outputContainer.innerHTML = html;

    requestAnimationFrame(fitPreviewToScreen);
    pdfExportBtn.style.display = 'block';
  }

  // 若 CDN 被擋，自動補載
  async function ensureLibs(){
    const hasCanvas = !!window.html2canvas;
    const hasPdfNS = (window.jspdf && (window.jspdf.jsPDF || window.jspdf)) || window.jsPDF;
    if(hasCanvas && hasPdfNS) return true;
    const load = (src)=>new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
    if(!hasCanvas) await load('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
    if(!hasPdfNS)  await load('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
    return true;
  }

  function isInAppBrowser(){
    const ua = navigator.userAgent || navigator.vendor || '';
    return /Line\/|FBAN|FBAV|Instagram|Twitter|Messenger/i.test(ua);
  }

  // 匯出 PDF：鎖版面 + A4 字級（12pt）+ 置中留白縮放 + in-app 分享/預覽備援
  async function exportToPDF(){
    const el = document.getElementById('pdf-content-wrapper');
    if(!el) return;

    try{ await ensureLibs(); }catch(e){ alert('無法載入必要函式庫，請改用本機檔。'); return; }

    window.__exporting = true;
    const prevScrollY = window.scrollY || 0;
    const prevTransform = el.style.transform;
    const prevFontSizeInline = el.style.fontSize;
    document.body.classList.add('exporting');

    // 匯出時：強制 A4 字級 12pt
    el.style.fontSize = '12pt';
    el.style.transform = 'none';
    window.scrollTo(0,0);

    try{
      if(document.fonts && document.fonts.ready){ try{ await document.fonts.ready; }catch(e){} }
      await new Promise(r => requestAnimationFrame(()=>requestAnimationFrame(r)));

      const safeScale = Math.min(1.5, window.devicePixelRatio || 1);
      const canvas = await html2canvas(el, {
        scale: safeScale, backgroundColor:'#ffffff', useCORS:true, allowTaint:true,
        scrollX:0, scrollY:0, windowWidth:Math.max(el.scrollWidth, el.offsetWidth, document.documentElement.clientWidth),
        windowHeight: el.scrollHeight
      });

      const img = canvas.toDataURL('image/jpeg', 0.98);
      const ns = window.jspdf || window.jsPDF;
      const Ctor = ns && (ns.jsPDF || ns);
      if(!Ctor) throw new Error('jsPDF 未載入');

      const pdf = new Ctor({ orientation:'portrait', unit:'mm', format:'a4' });
      const W = pdf.internal.pageSize.getWidth();
      const H = pdf.internal.pageSize.getHeight();

      // === 置中縮放到「邊界盒」：控制留白大小 ===
      const MARGIN_MM   = 18;   // 四邊固定留白（可調 16~22）
      const INSIDE_SCALE= 0.92; // 內容再微縮（0.90~0.95）
      const boxW = (W - MARGIN_MM * 2) * INSIDE_SCALE;
      const boxH = (H - MARGIN_MM * 2) * INSIDE_SCALE;

      let w = boxW;
      let h = (canvas.height / canvas.width) * w;
      if (h > boxH) {
        const r = boxH / h;
        w *= r; h *= r;
      }
      const x = (W - w) / 2;
      const y = (H - h) / 2;

      pdf.addImage(img, 'JPEG', x, y, w, h);

      const filename = `奇美合約注意事項_${currentOrderNumber || '未命名'}.pdf`;

      if (isInAppBrowser()) {
        const blob = pdf.output('blob');
        const file = new File([blob], filename, { type: 'application/pdf' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: filename, text: '奇美合約注意事項' });
        } else {
          const url = URL.createObjectURL(blob);
          location.href = url; // in-app 同頁開啟，最穩
        }
      } else {
        try{ pdf.save(filename); }
        catch(e){
          try{
            const blob = pdf.output('blob');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(url), 1500);
          }catch(_){
            const url = pdf.output('bloburl');
            window.open(url, '_blank');
          }
        }
      }
    }catch(err){
      console.error(err);
      alert('匯出失敗：請改用外部瀏覽器（Safari/Chrome）或稍後再試。');
    }finally{
      // 還原：字級/縮放/卷動
      el.style.fontSize = prevFontSizeInline || '';
      document.body.classList.remove('exporting');
      el.style.transform = prevTransform || '';
      if(prevScrollY) window.scrollTo(0, prevScrollY);
      window.__exporting = false;
      fitPreviewToScreen();
    }
  }
</script>
</body>
</html>
